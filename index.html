function doGet(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = sheet.getDataRange().getValues();
    var games = [];
    
    // Skip header row
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      if (row[0]) { // If name exists
        games.push({
          id: i,
          name: row[0],
          players: row[1],
          duration: row[2],
          cost: parseFloat(row[3]) || 0,
          available: String(row[4]).toUpperCase() === 'TRUE',
          checkedOutTo: row[5] || null,
          building: row[6] || null,
          apartment: row[7] || null,
          dueDate: row[8] || null
        });
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify(games))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: true,
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000);
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = JSON.parse(e.postData.contents);
    var row = data.gameId + 1; // Add 1 for header row
    
    if (data.action === 'checkout') {
      sheet.getRange(row, 5).setValue('FALSE'); // Available
      sheet.getRange(row, 6).setValue(data.name); // CheckedOutTo
      sheet.getRange(row, 7).setValue(data.building); // Building
      sheet.getRange(row, 8).setValue(data.apartment); // Apartment
      sheet.getRange(row, 9).setValue(data.dueDate); // DueDate
      sheet.getRange(row, 10).setValue(new Date().toLocaleDateString()); // Timestamp
    } 
    else if (data.action === 'return') {
      sheet.getRange(row, 5).setValue('TRUE'); // Available
      sheet.getRange(row, 6).setValue(''); // CheckedOutTo
      sheet.getRange(row, 7).setValue(''); // Building
      sheet.getRange(row, 8).setValue(''); // Apartment
      sheet.getRange(row, 9).setValue(''); // DueDate
      sheet.getRange(row, 10).setValue(new Date().toLocaleDateString()); // Timestamp
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      action: data.action,
      gameId: data.gameId
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: true,
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    if (lock.hasLock()) {
      lock.releaseLock();
    }
  }
}
