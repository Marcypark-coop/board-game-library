<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcy Park Co-op Board Game Library</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .policy-section {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .game-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .game-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .checkout-form {
            margin-top: 10px;
        }
        .checkout-form input {
            margin-bottom: 5px;
            padding: 5px;
            width: calc(100% - 10px);
        }
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }
        .button.admin {
            background-color: #e74c3c;
        }
        .button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .status-available {
            color: #27ae60;
            font-weight: bold;
        }
        .status-checked-out {
            color: #e74c3c;
            font-weight: bold;
        }
        .search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .warning {
            color: #e74c3c;
            font-weight: bold;
        }
        .sync-status {
            background-color: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .sync-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .sync-success {
            background-color: #28a745;
            color: white;
        }
        .sync-error {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Marcy Park Co-op Board Game Library</h1>
        <p>Browse and check out games from our collection</p>
        <div id="syncStatus" class="sync-status">Initializing...</div>
    </div>

    <div class="policy-section">
        <h3>üìö Checkout Policy</h3>
        <p><strong>Checkout Period:</strong> 15 days maximum before renewal is required</p>
        <p><strong>Late Returns:</strong></p>
        <ul>
            <li>A warning will be issued 1 week before the due date</li>
            <li>If not returned by the due date, you will be fined the full cost of the board game</li>
        </ul>
        <p><strong>Note:</strong> All checkouts require valid building and apartment information</p>
    </div>

    <input type="text" id="searchInput" class="search-bar" placeholder="Search for games...">
    <div id="gameList" class="game-list"></div>

    <script>
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxxda4-5uWDLwWTLBtiUhWJYPAuHW9nBLmrFWChxSVzrC_AyxMqKlN9LiDWaDBAERoj/exec',
            ADMIN_PASSWORD: 'admin123',
            SYNC_INTERVAL: 60000 // 1 minute
        };

        // Initial games data
        let games = [
            { id: 1, name: "Catan", players: "3-4", duration: "60-120 min", cost: 49.99, available: true, checkedOutTo: null, dueDate: null, building: null, apartment: null },
            { id: 2, name: "Ticket to Ride", players: "2-5", duration: "30-60 min", cost: 44.99, available: true, checkedOutTo: null, dueDate: null, building: null, apartment: null },
            { id: 3, name: "Pandemic", players: "2-4", duration: "45-60 min", cost: 39.99, available: true, checkedOutTo: null, dueDate: null, building: null, apartment: null },
            { id: 4, name: "Carcassonne", players: "2-5", duration: "30-45 min", cost: 34.99, available: true, checkedOutTo: null, dueDate: null, building: null, apartment: null }
        ];

        let isLoading = false;

        async function fetchGames() {
            if (isLoading) return;
            isLoading = true;

            try {
                console.log('Fetching games from:', CONFIG.SCRIPT_URL);
                const response = await fetch(CONFIG.SCRIPT_URL);
                console.log('Response status:', response.status);
                
                const text = await response.text();
                console.log('Response text:', text);
                
                const data = JSON.parse(text);
                if (Array.isArray(data)) {
                    games = data;
                    updateSyncStatus('Sync successful', true);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                updateSyncStatus('Using local data (sync failed)', false);
            } finally {
                isLoading = false;
                renderGames(games);
            }
        }

        async function updateSheet(data) {
            try {
                const response = await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                // With no-cors, assume success if no error
                return true;
            } catch (error) {
                console.error('Update error:', error);
                return false;
            }
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            let warningMessage = '';
            if (game.dueDate) {
                const due = new Date(game.dueDate);
                const today = new Date();
                const daysUntilDue = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 7 && daysUntilDue > 0) {
                    warningMessage = `<p class="warning">‚ö†Ô∏è Warning: Due in ${daysUntilDue} days</p>`;
                } else if (daysUntilDue <= 0) {
                    warningMessage = `<p class="warning">‚ö†Ô∏è OVERDUE - Fine: $${game.cost}</p>`;
                }
            }

            card.innerHTML = `
                <h3>${game.name}</h3>
                <p>Players: ${game.players}</p>
                <p>Duration: ${game.duration}</p>
                <p>Replacement Cost: $${game.cost}</p>
                <p>Status: <span class="${game.available ? 'status-available' : 'status-checked-out'}">
                    ${game.available ? 'Available' : 'Checked Out'}
                </span></p>
                ${game.checkedOutTo ? `
                    <p>Checked out to: ${game.checkedOutTo}<br>
                    Building: ${game.building}, Apt: ${game.apartment}<br>
                    Due: ${game.dueDate}</p>
                    ${warningMessage}
                ` : ''}
                <div class="checkout-form">
                    ${game.available ? `
                        <input type="text" id="name-${game.id}" placeholder="Your name" required>
                        <input type="text" id="building-${game.id}" placeholder="Building number" required>
                        <input type="text" id="apartment-${game.id}" placeholder="Apartment number" required>
                        <button class="button" onclick="checkoutGame(${game.id})" ${isLoading ? 'disabled' : ''}>
                            Check Out
                        </button>
                    ` : `
                        <input type="password" id="password-${game.id}" placeholder="Admin password">
                        <button class="button admin" onclick="returnGame(${game.id})" ${isLoading ? 'disabled' : ''}>
                            Return Game (Admin Only)
                        </button>
                    `}
                </div>
            `;
            return card;
        }

        async function checkoutGame(gameId) {
            const game = games.find(g => g.id === gameId);
            const nameInput = document.getElementById(`name-${gameId}`);
            const buildingInput = document.getElementById(`building-${gameId}`);
            const apartmentInput = document.getElementById(`apartment-${gameId}`);
            
            if (!nameInput.value.trim() || !buildingInput.value.trim() || !apartmentInput.value.trim()) {
                alert('Please fill in all fields');
                return;
            }

            updateSyncStatus('Updating...', true);
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 15);
            const dueDateStr = dueDate.toLocaleDateString();

            const success = await updateSheet({
                action: 'checkout',
                gameId: game.id,
                name: nameInput.value.trim(),
                building: buildingInput.value.trim(),
                apartment: apartmentInput.value.trim(),
                dueDate: dueDateStr
            });

            if (success) {
                game.available = false;
                game.checkedOutTo = nameInput.value.trim();
                game.building = buildingInput.value.trim();
                game.apartment = apartmentInput.value.trim();
                game.dueDate = dueDateStr;
                
                renderGames(games);
                updateSyncStatus('Checkout successful', true);
                alert(`Checkout successful! Due date: ${dueDateStr}`);
            } else {
                updateSyncStatus('Checkout failed', false);
                alert('Checkout failed. Please try again.');
            }
        }

        async function returnGame(gameId) {
            const game = games.find(g => g.id === gameId);
            const passwordInput = document.getElementById(`password-${gameId}`);
            
            if (passwordInput.value !== CONFIG.ADMIN_PASSWORD) {
                alert('Incorrect admin password');
                return;
            }

            updateSyncStatus('Updating...', true);
            const success = await updateSheet({
                action: 'return',
                gameId: game.id
            });

            if (success) {
                game.available = true;
                game.checkedOutTo = null;
                game.building = null;
                game.apartment = null;
                game.dueDate = null;
                
                renderGames(games);
                updateSyncStatus('Return successful', true);
                alert('Game successfully returned');
            } else {
                updateSyncStatus('Return failed', false);
                alert('Return failed. Please try again.');
            }
        }

        function renderGames(gameList) {
            const container = document.getElementById('gameList');
            container.innerHTML = '';
            gameList.forEach(game => {
                container.appendChild(createGameCard(game));
            });
        }

        function updateSyncStatus(message, success) {
            const status = document.getElementById('syncStatus');
            status.innerHTML = `
                ${message}
                <span class="sync-badge ${success ? 'sync-success' : 'sync-error'}">
                    ${new Date().toLocaleString()}
                </span>
            `;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredGames = games.filter(game => 
                game.name.toLowerCase().includes(searchTerm)
            );
            renderGames(filteredGames);
        });

        // Initialize with local data first
        renderGames(games);
        updateSyncStatus('Using local data', false);

        // Try initial sync after a short delay
        setTimeout(fetchGames, 1000);
        
        // Set up periodic sync
        setInterval(fetchGames, CONFIG.SYNC_INTERVAL);
    </script>
</body>
</html>
