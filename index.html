<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcy Park Co-op Board Game Library</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .policy-section {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .game-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .game-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .checkout-form {
            margin-top: 10px;
        }
        .checkout-form input {
            margin-bottom: 5px;
            padding: 5px;
            width: calc(100% - 10px);
        }
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }
        .button.admin {
            background-color: #e74c3c;
        }
        .button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .status-available {
            color: #27ae60;
            font-weight: bold;
        }
        .status-checked-out {
            color: #e74c3c;
            font-weight: bold;
        }
        .search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .warning {
            color: #e74c3c;
            font-weight: bold;
        }
        .sync-status {
            background-color: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .sync-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .sync-success {
            background-color: #28a745;
            color: white;
        }
        .sync-error {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Marcy Park Co-op Board Game Library</h1>
        <p>Browse and check out games from our collection</p>
        <div id="syncStatus" class="sync-status">Initializing...</div>
    </div>

    <div class="policy-section">
        <h3>üìö Checkout Policy</h3>
        <p><strong>Checkout Period:</strong> 15 days maximum before renewal is required</p>
        <p><strong>Late Returns:</strong></p>
        <ul>
            <li>A warning will be issued 1 week before the due date</li>
            <li>If not returned by the due date, you will be fined the full cost of the board game</li>
        </ul>
        <p><strong>Note:</strong> All checkouts require valid building and apartment information</p>
    </div>

    <input type="text" id="searchInput" class="search-bar" placeholder="Search for games...">
    <div id="gameList" class="game-list"></div>

    <script>
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbx4QmFTP7V9JfPbjyyyNeZ7zULdyVAz427UfpTx0oZ9lBmHBswF17gx66L2qZuvcK_d/exec',
            ADMIN_PASSWORD: 'admin123',
            SYNC_INTERVAL: 60000 // 1 minute
        };

        let games = [];

        async function fetchGames() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getGames`);
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    games = data;
                    updateSyncStatus('Sync successful', true);
                    renderGames(games);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                updateSyncStatus(`Sync failed: ${error.message}`, false);
            }
        }

        async function updateSheet(data) {
            try {
                await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                await fetchGames();
                return true;
            } catch (error) {
                console.error('Update error:', error);
                return false;
            }
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            let warningMessage = '';
            if (game.dueDate) {
                const due = new Date(game.dueDate);
                const today = new Date();
                const daysUntilDue = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 7 && daysUntilDue > 0) {
                    warningMessage = `<p class="warning">‚ö†Ô∏è Warning: Due in ${daysUntilDue} days</p>`;
                } else if (daysUntilDue <= 0) {
                    warningMessage = `<p class="warning">‚ö†Ô∏è OVERDUE - Fine: $${game.cost}</p>`;
                }
            }

            card.innerHTML = `
                <h3>${game.name}</h3>
                <p>Players: ${game.players}</p>
                <p>Duration: ${game.duration}</p>
                <p>Replacement Cost: $${game.cost}</p>
                <p>Status: <span class="${game.available ? 'status-available' : 'status-checked-out'}">
                    ${game.available ? 'Available' : 'Checked Out'}
                </span></p>
                ${game.checkedOutTo ? `
                    <p>Checked out to: ${game.checkedOutTo}<br>
                    Email: ${game.email}<br>
                    Building: ${game.building}, Apt: ${game.apartment}<br>
                    Due: ${game.dueDate}</p>
                    ${warningMessage}
                ` : ''}
                <div class="checkout-form">
                    ${game.available ? `
                        <input type="text" id="name-${game.id}" placeholder="Your name" required>
                        <input type="email" id="email-${game.id}" placeholder="Your email" required>
                        <input type="text" id="building-${game.id}" placeholder="Building number" required>
                        <input type="text" id="apartment-${game.id}" placeholder="Apartment number" required>
                        <button class="button" onclick="checkoutGame(${game.id})">
                            Check Out
                        </button>
                    ` : `
                        <input type="password" id="password-${game.id}" placeholder="Admin password">
                        <button class="button admin" onclick="returnGame(${game.id})">
                            Return Game (Admin Only)
                        </button>
                    `}
                </div>
            `;
            return card;
        }

        async function checkoutGame(gameId) {
            const game = games.find(g => g.id === gameId);
            const nameInput = document.getElementById(`name-${gameId}`);
            const emailInput = document.getElementById(`email-${gameId}`);
            const buildingInput = document.getElementById(`building-${gameId}`);
            const apartmentInput = document.getElementById(`apartment-${gameId}`);
            
            if (!nameInput.value.trim() || !emailInput.value.trim() || 
                !buildingInput.value.trim() || !apartmentInput.value.trim()) {
                alert('Please fill in all fields');
                return;
            }

            if (!emailInput.value.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            updateSyncStatus('Processing checkout...', true);
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 15);
            const dueDateStr = dueDate.toLocaleDateString();

            const success = await updateSheet({
                action: 'checkout',
                gameId: game.id,
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                building: buildingInput.value.trim(),
                apartment: apartmentInput.value.trim(),
                dueDate: dueDateStr
            });

            updateSyncStatus(success ? 'Checkout successful' : 'Checkout failed', success);
        }

        async function returnGame(gameId) {
            const passwordInput = document.getElementById(`password-${gameId}`);
            if (passwordInput.value !== CONFIG.ADMIN_PASSWORD) {
                alert('Incorrect password');
                return;
            }

            updateSyncStatus('Processing return...', true);
            const success = await updateSheet({
                action: 'return',
                gameId: gameId
            });

            updateSyncStatus(success ? 'Return successful' : 'Return failed', success);
        }

        function renderGames(games) {
            const gameList = document.getElementById('gameList');
            gameList.innerHTML = '';
            games.forEach(game => {
                gameList.appendChild(createGameCard(game));
            });
        }

        function updateSyncStatus(message, success) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.innerHTML = message;
            syncStatus.className = 'sync-status sync-badge ' + (success ? 'sync-success' : 'sync-error');
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredGames = games.filter(game => game.name.toLowerCase().includes(searchTerm));
            renderGames(filteredGames);
        });

        fetchGames();
        setInterval(fetchGames, CONFIG.SYNC_INTERVAL);
    </script>
</body>
</html>
